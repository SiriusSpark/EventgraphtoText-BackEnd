"use strict";(self["webpackChunktext_generation_system"]=self["webpackChunktext_generation_system"]||[]).push([[795],{5795:function(e,l,t){t.r(l),t.d(l,{default:function(){return C}});t(4114),t(8111),t(2489),t(116),t(1701);var a=t(6768),r=t(4232),n=t(144),u=t(1387),o=t(1219),s=t(47),d=t(7377),i=t(4656),c=t(6018),v=t(8270),p=t(5720);function g(e){return console.log("创建关系API调用:",e),(0,p.A)({url:"/api/graph/edges",method:"post",data:e})}function h(e){console.log(`删除关系API调用: id=${e}`);let l=e;if("string"===typeof e&&e.includes(":")){const t=e.split(":");l=t[t.length-1]}return(0,p.A)({url:`/api/graph/edges/${l}`,method:"delete"})}var f=t(3464),k=t(7477);const y={class:"event-graph-visualize-container"},b={class:"header"},m={class:"description"},x={class:"header-actions"},R={class:"visualization-wrapper"},E={class:"visualization-container"},I={class:"dialog-footer"},_={class:"dialog-footer"};var F={__name:"visualize",setup(e){const l=(0,u.lq)(),t=(0,u.rd)(),p=(0,n.KR)(!1),F=(0,n.KR)(null),S=(0,n.KR)({title:"",description:"",nodes:[],edges:[]}),w=(0,n.KR)([]),C=(0,n.KR)(-1),L=(0,a.EW)((()=>l.params.id)),A=(0,a.EW)((()=>C.value>0)),U=(0,a.EW)((()=>C.value<w.value.length-1&&C.value>=0)),V={PRECEDES:"#4285F4",FOLLOWS:"#34A853",CONCURRENT_WITH:"#8F44AD",CAUSES:"#EA4335",RESULTS_IN:"#FBBC05",COREFERS_TO:"#00ACC1",HAS_SUBEVENT:"#FF5722",SUBEVENT_OF:"#795548"},N=e=>{const l={PRECEDES:"先于",FOLLOWS:"后于",CONCURRENT_WITH:"同时",CAUSES:"导致",RESULTS_IN:"结果",COREFERS_TO:"共指",HAS_SUBEVENT:"包含子事件",SUBEVENT_OF:"属于"};return l[e]||e},T=()=>{t.push("/event-graph/list")},$=e=>{let l=-1;if("prev"===e&&A.value?l=C.value-1:"next"===e&&U.value&&(l=C.value+1),l>=0&&l<w.value.length){const e=w.value[l];p.value=!0,t.push(`/event-graph/visualize/${e.id}`).then((()=>{O().then((()=>{C.value=l}))}))}},W=async()=>{try{const e=await(0,v.Z$)();e&&Array.isArray(e)?w.value=e.sort(((e,l)=>e.id-l.id)):e&&e.success&&Array.isArray(e.data)?w.value=e.data.sort(((e,l)=>e.id-l.id)):(console.error("获取事件图列表失败"),w.value=[]),L.value&&(C.value=w.value.findIndex((e=>e.id==L.value)))}catch(e){console.error("获取事件图列表失败:",e),o.nk.error("获取事件图列表失败"),w.value=[]}},O=async()=>{if(L.value){p.value=!0;try{console.log("获取事件图详情:",L.value);const e=await(0,v.kW)(L.value);console.log("事件图详情数据:",e),e&&e.success&&e.data?(S.value=e.data,await(0,a.dY)(),Q()):o.nk.error(e?.message||e?.error||"获取事件图详情失败")}catch(e){console.error("获取事件图详情失败:",e),o.nk.error("获取事件图详情失败")}finally{p.value=!1}}else o.nk.error("未找到事件图ID")},K=(0,n.KR)(0),P=(0,n.KR)([]),G=(0,n.KR)(!1),B=(0,n.KR)(!1),X=(0,n.KR)({id:null,eventGraphId:Number(L.value),sourceId:null,targetId:null,type:"",strength:null}),z=(e,l)=>{const t=S.value.edges||[];return console.log("检查关系，节点ID:",e,l),console.log("所有边:",t),t.find((t=>t.sourceId===e&&t.targetId===l||t.sourceId===l&&t.targetId===e))},D=()=>{if(2!==P.value.length)return;const[e,l]=P.value,t=z(e.id,l.id);console.log("固定的节点:",P.value),console.log("找到的关系:",t),X.value={id:t?t.id:null,eventGraphId:Number(L.value),sourceId:e.id,targetId:l.id,type:t?.type||"",strength:"CAUSES"===t?.type||"RESULTS_IN"===t?.type?t?.strength||"低":null},console.log("表单数据:",X.value),t?B.value=!0:G.value=!0},H=()=>{console.log("释放固定节点"),F.value&&f.Ltv(F.value).selectAll(".node").each((function(e){e.fixed&&(console.log("释放节点:",e.title),e.fixed=!1,e.fx=null,e.fy=null,f.Ltv(this).select(".node-highlight").classed("fixed",!1).classed("visible",!1).style("opacity",0))})),P.value=[],K.value=0},q=()=>{H(),G.value=!1,B.value=!1},M=async()=>{try{if(["CAUSES","RESULTS_IN"].includes(X.value.type)?X.value.strength||(X.value.strength="低"):X.value.strength=null,G.value){console.log("创建关系请求数据:",{eventGraphId:Number(X.value.eventGraphId),sourceId:X.value.sourceId,targetId:X.value.targetId,type:X.value.type,strength:X.value.strength});const e=await g({eventGraphId:Number(X.value.eventGraphId),sourceId:X.value.sourceId,targetId:X.value.targetId,type:X.value.type,strength:X.value.strength});if(console.log("创建关系响应:",e),!e.success)throw new Error(e.error||"创建关系失败");o.nk.success("创建关系成功")}else{const l=X.value.id;console.log("更新关系请求数据:",{eventGraphId:Number(X.value.eventGraphId),sourceId:X.value.sourceId,targetId:X.value.targetId,type:X.value.type,strength:X.value.strength});const t=await g({eventGraphId:Number(X.value.eventGraphId),sourceId:X.value.sourceId,targetId:X.value.targetId,type:X.value.type,strength:X.value.strength});if(console.log("创建新关系响应:",t),!t.success)throw new Error(t.error||"更新关系失败: 创建新关系失败");if(l)try{console.log("删除旧关系:",l);const e=await h(l);console.log("删除旧关系响应:",e),e.success||console.warn("删除旧关系失败:",e.error||"未知错误")}catch(e){console.error("删除旧关系出错:",e)}o.nk.success("更新关系成功")}G.value=!1,B.value=!1,H(),await O()}catch(l){console.error("保存关系失败:",l),o.nk.error(l.message||"保存关系失败")}},Q=()=>{if(!F.value)return;f.Ltv(F.value).selectAll("*").remove(),P.value=[],K.value=0;const e=S.value.nodes||[],l=(S.value.edges||[]).map((e=>({id:e.id,source:e.sourceId,target:e.targetId,type:e.type,strength:e.strength})));if(!e.length)return void console.error("没有节点数据");const t=F.value.clientWidth,a=F.value.clientHeight||800,r=f.Ltv(F.value).append("svg").attr("width",t).attr("height",a).attr("viewBox",[0,0,t,a]).attr("style","max-width: 100%; height: auto;");r.on("contextmenu",(e=>{e.preventDefault()})),r.append("defs").selectAll("marker").data(Object.keys(V)).enter().append("marker").attr("id",(e=>`arrow-${e}`)).attr("viewBox","0 -5 10 10").attr("refX",25).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("fill",(e=>V[e])).attr("d","M0,-5L10,0L0,5");const n=r.append("g"),u=f.s_O().scaleExtent([.1,4]).on("zoom",(e=>{n.attr("transform",e.transform)}));r.call(u);const s=f.tXi(e).force("link",f.kJC(l).id((e=>e.id)).distance(150)).force("charge",f.xJS().strength(-400)).force("center",f.jTM(t/2,a/2)).force("collision",f.eRw().radius(60)),d=n.append("g").attr("stroke-opacity",.6).selectAll("g").data(l).enter().append("g");d.append("path").attr("stroke",(e=>V[e.type]||"#999")).attr("stroke-width",2).attr("fill","none").attr("marker-end",(e=>`url(#arrow-${e.type})`)).attr("id",(e=>`link-${e.id}`)),d.append("text").attr("dy",-5).attr("text-anchor","middle").attr("fill","#666").append("textPath").attr("xlink:href",(e=>`#link-${e.id}`)).attr("startOffset","50%").text((e=>{let l=N(e.type);return"CAUSES"!==e.type&&"RESULTS_IN"!==e.type||(l+=e.strength?`(${e.strength})`:""),l}));const i=n.append("g").selectAll(".node").data(e).enter().append("g").attr("class","node").call(f.$Er().on("start",c).on("drag",v).on("end",p));function c(e,l){e.active||s.alphaTarget(.3).restart(),l.fx=l.x,l.fy=l.y}function v(e,l){l.fx=e.x,l.fy=e.y}function p(e,l){e.active||s.alphaTarget(0),l.fixed||(l.fx=null,l.fy=null)}i.append("circle").attr("class","node-highlight").attr("r",36).style("opacity",0).style("filter","blur(2px)"),i.append("circle").attr("r",30).attr("fill","#39c5bb").attr("stroke","#2a9d8f").attr("stroke-width",2),i.append("text").attr("text-anchor","middle").attr("fill","#fff").attr("dy",".3em").text((e=>e.title)),i.append("title").text((e=>`${e.title}\n${e.description}`)),i.on("mouseenter",(function(e,l){l.fixed||f.Ltv(this).select(".node-highlight").classed("visible",!0).style("opacity",.3)})).on("mouseleave",(function(e,l){l.fixed||f.Ltv(this).select(".node-highlight").classed("visible",!1).style("opacity",0)})).on("contextmenu",(function(e,l){if(e.preventDefault(),console.log("右键点击节点:",l,"当前固定节点数:",K.value),l.fixed)l.fixed=!1,l.fx=null,l.fy=null,K.value--,P.value=P.value.filter((e=>e.id!==l.id)),f.Ltv(this).select(".node-highlight").classed("fixed",!1).classed("visible",!1).style("opacity",0),console.log("节点解除固定, 当前固定节点数:",K.value);else if(K.value<2){l.fixed=!0,l.fx=l.x,l.fy=l.y,K.value++;const e={id:l.id,title:l.title,description:l.description};console.log("添加固定节点:",e,"当前固定节点数:",K.value),P.value.push(e),f.Ltv(this).select(".node-highlight").classed("fixed",!0).classed("visible",!0).style("opacity",.5),2===K.value&&(console.log("固定了两个节点，准备打开对话框"),D())}else console.log("已经固定了两个节点，不能再固定更多"),o.nk.warning("最多只能固定两个节点。请先右键点击已固定节点取消固定，再尝试固定此节点。")})),s.on("tick",(()=>{d.select("path").attr("d",(e=>{e.target.x,e.source.x,e.target.y,e.source.y;return`M${e.source.x},${e.source.y}L${e.target.x},${e.target.y}`})),i.attr("transform",(e=>`translate(${e.x},${e.y})`))}))};return(0,a.wB)((()=>l.params.id),((e,l)=>{e&&e!==l&&(O(),w.value.length>0&&(C.value=w.value.findIndex((l=>l.id==e))))})),(0,a.sV)((async()=>{await W(),O();const e=()=>{S.value.nodes&&S.value.nodes.length&&Q()};return window.addEventListener("resize",e),()=>{window.removeEventListener("resize",e)}})),(e,l)=>{const t=(0,a.g2)("el-icon"),u=(0,a.g2)("el-card"),o=(0,a.g2)("el-input"),v=(0,a.gN)("loading");return(0,a.uX)(),(0,a.CE)("div",y,[(0,a.Lk)("div",b,[(0,a.Lk)("div",null,[(0,a.Lk)("h2",null,"事件图可视化："+(0,r.v_)(S.value.title),1),(0,a.Lk)("div",m,(0,r.v_)(S.value.description),1)]),(0,a.Lk)("div",x,[(0,a.bF)((0,n.R1)(s.S2),{onClick:T},{default:(0,a.k6)((()=>l[8]||(l[8]=[(0,a.eW)("返回列表")]))),_:1})])]),(0,a.Lk)("div",R,[(0,a.Lk)("div",{class:(0,r.C4)(["nav-button left-button",{disabled:!A.value}]),onClick:l[0]||(l[0]=e=>$("prev"))},[(0,a.bF)(t,null,{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(k.nkM))])),_:1})],2),(0,a.bo)(((0,a.uX)(),(0,a.CE)("div",E,[(0,a.bF)(u,{class:"legend"},{default:(0,a.k6)((()=>[l[9]||(l[9]=(0,a.Lk)("h3",null,"关系类型",-1)),((0,a.uX)(),(0,a.CE)(a.FK,null,(0,a.pI)(V,((e,l)=>(0,a.Lk)("div",{key:l,class:"legend-item"},[(0,a.Lk)("div",{class:"color-dot",style:(0,r.Tr)({backgroundColor:e})},null,4),(0,a.Lk)("span",null,(0,r.v_)(N(l)),1)]))),64))])),_:1}),(0,a.Lk)("div",{id:"graph-container",ref_key:"graphContainer",ref:F},null,512)])),[[v,p.value]]),(0,a.Lk)("div",{class:(0,r.C4)(["nav-button right-button",{disabled:!U.value}]),onClick:l[1]||(l[1]=e=>$("next"))},[(0,a.bF)(t,null,{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(k.Qpb))])),_:1})],2)]),(0,a.bF)((0,n.R1)(d.kZ),{modelValue:G.value,"onUpdate:modelValue":l[4]||(l[4]=e=>G.value=e),title:"添加连接",width:"500px","close-on-click-modal":!1,onClose:H},{footer:(0,a.k6)((()=>[(0,a.Lk)("span",I,[(0,a.bF)((0,n.R1)(s.S2),{onClick:q},{default:(0,a.k6)((()=>l[10]||(l[10]=[(0,a.eW)("取消")]))),_:1}),(0,a.bF)((0,n.R1)(s.S2),{type:"primary",onClick:M},{default:(0,a.k6)((()=>l[11]||(l[11]=[(0,a.eW)("确定")]))),_:1})])])),default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(i.US),{model:X.value,"label-width":"80px"},{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(i.xE),{label:"起点"},{default:(0,a.k6)((()=>[(0,a.bF)(o,{value:P.value.length>0?P.value[0].title:"",disabled:""},null,8,["value"])])),_:1}),(0,a.bF)((0,n.R1)(i.xE),{label:"终点"},{default:(0,a.k6)((()=>[(0,a.bF)(o,{value:P.value.length>1?P.value[1].title:"",disabled:""},null,8,["value"])])),_:1}),(0,a.bF)((0,n.R1)(i.xE),{label:"关系类型",required:""},{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(c.AV),{modelValue:X.value.type,"onUpdate:modelValue":l[2]||(l[2]=e=>X.value.type=e),placeholder:"请选择关系类型",style:{width:"100%"}},{default:(0,a.k6)((()=>[((0,a.uX)(),(0,a.CE)(a.FK,null,(0,a.pI)(V,((e,l)=>(0,a.bF)((0,n.R1)(c.P9),{key:l,label:N(l),value:l},null,8,["label","value"]))),64))])),_:1},8,["modelValue"])])),_:1}),["CAUSES","RESULTS_IN"].includes(X.value.type)?((0,a.uX)(),(0,a.Wv)((0,n.R1)(i.xE),{key:0,label:"关系强度",required:""},{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(c.AV),{modelValue:X.value.strength,"onUpdate:modelValue":l[3]||(l[3]=e=>X.value.strength=e),placeholder:"请选择关系强度",style:{width:"100%"}},{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(c.P9),{label:"高",value:"高"}),(0,a.bF)((0,n.R1)(c.P9),{label:"中",value:"中"}),(0,a.bF)((0,n.R1)(c.P9),{label:"低",value:"低"})])),_:1},8,["modelValue"])])),_:1})):(0,a.Q3)("",!0)])),_:1},8,["model"])])),_:1},8,["modelValue"]),(0,a.bF)((0,n.R1)(d.kZ),{modelValue:B.value,"onUpdate:modelValue":l[7]||(l[7]=e=>B.value=e),title:"编辑连接",width:"500px","close-on-click-modal":!1,onClose:H},{footer:(0,a.k6)((()=>[(0,a.Lk)("span",_,[(0,a.bF)((0,n.R1)(s.S2),{onClick:q},{default:(0,a.k6)((()=>l[12]||(l[12]=[(0,a.eW)("取消")]))),_:1}),(0,a.bF)((0,n.R1)(s.S2),{type:"primary",onClick:M},{default:(0,a.k6)((()=>l[13]||(l[13]=[(0,a.eW)("确定")]))),_:1})])])),default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(i.US),{model:X.value,"label-width":"80px"},{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(i.xE),{label:"起点"},{default:(0,a.k6)((()=>[(0,a.bF)(o,{value:P.value.length>0?P.value[0].title:"",disabled:""},null,8,["value"])])),_:1}),(0,a.bF)((0,n.R1)(i.xE),{label:"终点"},{default:(0,a.k6)((()=>[(0,a.bF)(o,{value:P.value.length>1?P.value[1].title:"",disabled:""},null,8,["value"])])),_:1}),(0,a.bF)((0,n.R1)(i.xE),{label:"关系类型",required:""},{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(c.AV),{modelValue:X.value.type,"onUpdate:modelValue":l[5]||(l[5]=e=>X.value.type=e),placeholder:"请选择关系类型",style:{width:"100%"}},{default:(0,a.k6)((()=>[((0,a.uX)(),(0,a.CE)(a.FK,null,(0,a.pI)(V,((e,l)=>(0,a.bF)((0,n.R1)(c.P9),{key:l,label:N(l),value:l},null,8,["label","value"]))),64))])),_:1},8,["modelValue"])])),_:1}),["CAUSES","RESULTS_IN"].includes(X.value.type)?((0,a.uX)(),(0,a.Wv)((0,n.R1)(i.xE),{key:0,label:"关系强度",required:""},{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(c.AV),{modelValue:X.value.strength,"onUpdate:modelValue":l[6]||(l[6]=e=>X.value.strength=e),placeholder:"请选择关系强度",style:{width:"100%"}},{default:(0,a.k6)((()=>[(0,a.bF)((0,n.R1)(c.P9),{label:"高",value:"高"}),(0,a.bF)((0,n.R1)(c.P9),{label:"中",value:"中"}),(0,a.bF)((0,n.R1)(c.P9),{label:"低",value:"低"})])),_:1},8,["modelValue"])])),_:1})):(0,a.Q3)("",!0)])),_:1},8,["model"])])),_:1},8,["modelValue"])])}}},S=t(1241);const w=(0,S.A)(F,[["__scopeId","data-v-50cd3cc3"]]);var C=w}}]);